<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <title>PCT Photos</title>
    //<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/jquery.slick/1.5.7/slick.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/jquery.slick/1.5.8/slick-theme.css"/>
    <style>
        body { padding: 0; margin: 0; height: 100vh; }
        #map { height: 75vh; }
        #image { height: 25vh; background-color: black; }
        #image .item { height: 100%; max-height: 100%; }
        #image .item img { height: 25vh; max-height: 25vh; }
        .slick-slider { margin-bottom: 0; }
	.slick-next { float: right; z-index: 1; right: 0; }
	.slick-prev { float: left; z-index: 1; left: 0; }
	@media only screen and (max-width: 960px) {
		.slick-arrow {
			display: none !important;
		}
	}

    </style>
</head>
<body>
    <div id="wrapper">
        <div id="map"></div>
        <div id="image" class="owl-carousel"></div>
    </div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
//<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>
<script src="./js/leaflet.ajax.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery.slick/1.5.7/slick.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.pack.js"></script>
<script>
    var latLngs = 'https://bwainstock.cartodb.com/api/v2/sql?format=GeoJSON&q=SELECT%20*%20FROM%20pct_pictures%20ORDER%20BY%20date_taken,%20time_taken&api_key=7c40f7f14e75856647c35fb916c3a1cdf73b4a70';
    var lineURL = "https://bwainstock.cartodb.com/api/v2/sql?format=GeoJSON&q=SELECT ST_MakeLine(the_geom ORDER BY unixtime) as the_geom from test WHERE feedid = '0hhvvy86u7pTm6F1UytYEAj2uhyXUOt1u'&api_key=7c40f7f14e75856647c35fb916c3a1cdf73b4a70";
    var map = L.map('map').setView([32.6064, -116.4681], 9);
    var Thunderforest_Landscape = L.tileLayer('http://{s}.tile.thunderforest.com/landscape/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://www.opencyclemap.org">OpenCycleMap</a>, &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    });

    var data = []; //debug data

    var goldStarIcon = L.divIcon({
        className: 'fa-icon fa fa-star fa-2x',
        html: '<style>.fa-icon { color: #FFCC00 }</style>'
    });

    var largeGoldStarIcon = L.divIcon({
        className: 'fa-icon fa fa-star fa-3x',
        html: '<style>.fa-icon { color: #FFCC00 }</style>'
    });

    var xlargeGoldStarIcon = L.divIcon({
        className: 'fa-icon fa fa-star fa-4x',
        html: '<style>.fa-icon { color: #FFCC00 }</style>'
    });

    var redStarIcon = L.divIcon({
        className: 'selected-icon fa fa-star fa-2x',
        html: '<style>.selected-icon { color: red }</style>'
    });

    var largeRedStarIcon = L.divIcon({
        className: 'selected-icon fa fa-star fa-3x',
        html: '<style>.selected-icon { color: red }</style>'
    });

    var xlargeRedStarIcon = L.divIcon({
        className: 'selected-icon fa fa-star fa-4x',
        html: '<style>.selected-icon { color: red }</style>'
    });

    var lineLayer = L.geoJson.ajax(lineURL, {
        dataType: "jsonp",
        style: {
            "color": "black",
            "dashArray": "5,20",
            "clickable": false,
        },
    });

    var geoJsonLayer = L.geoJson.ajax(latLngs, {
        dataType: "jsonp",

        onEachFeature: function (feature, layer) {
            var popupHTML = '<a href="' + feature.properties.url + '"  class="fancybox"><img width="250px" src="' + feature.properties.url + '"/></a>';
            var popupOptions = {
                'maxWidth': '500',
                'className' : 'image'
            };
            if (feature.properties) {
//                layer.bindPopup(popupHTML, popupOptions);
                data.push(feature.properties);
                var coords = feature.properties.lat.toFixed(6) + ',' + feature.properties.lon.toFixed(6);
                $( '#image').append('<div class="item"><a class="fancybox" href="' + feature.properties.url + '"><img carto-id="' + feature.properties.cartodb_id + '"coords="' + coords + '" data-lazy="' + feature.properties.url + '"></a></div>');

            }
        },

        pointToLayer: function (feature, latlng) {
            return L.marker(latlng, {icon: goldStarIcon, alt: feature.properties.cartodb_id});
        }
    });

   map.on('zoomend', function (e) {
       var zoomLevel = map.getZoom();
       geoJsonLayer.eachLayer(function (marker) {
           if (zoomLevel > 13) {
             marker.setIcon(xlargeGoldStarIcon);
           }
           else if (zoomLevel == 12 || zoomLevel == 13) {
             marker.setIcon(largeGoldStarIcon);
           }
           else {
             marker.setIcon(goldStarIcon);
           }
       });
   });

    Thunderforest_Landscape.addTo(map);
    geoJsonLayer.addTo(map);
    lineLayer.addTo(map);
    map.fitBounds(geoJsonLayer.getBounds());


</script>
<script>
    $( window ).load(function() {

        $(".fancybox").fancybox({
            padding : 0,
            closeClick: true
        });

        var imageWrapper = $('#image');
        imageWrapper.slick({
            lazyLoad: 'ondemand',
            slidesToShow: 5,
            slidesToScroll: 1,
//            arrows: false,
            centerMode: true,
            variableWidth: true,
            focusOnSelect: true,
            infinite: false
        });

        geoJsonLayer.eachLayer(function(layer) {
            layer.on('click', function(event){
                var imgID = event.target.options.alt;
//                console.log(event.latlng);
                var imgDiv = $('img[carto-id="' + imgID + '"]');
                var imgIndex = imgDiv.parents('div.item').attr('data-slick-index');
//                console.log(imgDiv);
//                console.log(imgIndex);
                imageWrapper.slick('slickGoTo', imgIndex);
//                imageWrapper.slick('slickGoTo', imgIndex);

            });
        });

        imageWrapper.on('beforeChange', function (event, slick, currentSlide, nextSlide) {
            var zoomLevel = map.getZoom();
            var currentSlideNum = currentSlide;
            var currentSlideDiv = $('div[data-slick-index=' + currentSlideNum + ']');
            var currentImgDiv = currentSlideDiv.find('img');
            var currentCartoID = currentImgDiv .attr('carto-id');

            var nextSlideNum = nextSlide;
            var nextSlideDiv = $('div[data-slick-index=' + nextSlideNum + ']');
            var nextImgDiv = nextSlideDiv.find('img');
            var nextCartoID = nextImgDiv .attr('carto-id');
            console.log(currentCartoID);
            geoJsonLayer.eachLayer(function(marker){
               if (marker.options.alt == currentCartoID) {
                 if (zoomLevel > 13) {
                   marker.setIcon(xlargeGoldStarIcon);
                 }
                 else if (zoomLevel == 12 || zoomLevel == 13) {
                   marker.setIcon(largeGoldStarIcon);
                 }
                 else {
                   marker.setIcon(goldStarIcon);
                 }
               }
               if (marker.options.alt == nextCartoID) {
                 if (zoomLevel > 13) {
                   marker.setIcon(xlargeRedStarIcon);
                 }
                 else if (zoomLevel == 12 || zoomLevel == 13) {
                   marker.setIcon(largeRedStarIcon);
                 }
                 else {
                   marker.setIcon(redStarIcon);
                 }
               }
            });
        });

        imageWrapper.on('afterChange', function(event, slick, currentSlide){
            var slideNum = currentSlide;
            var slideDiv = $('div[data-slick-index=' + slideNum + ']');
            var imgDiv = slideDiv.find('img');
//            console.log(imgDiv);
            var coords = imgDiv.attr('coords').split(',');

            var lat = parseFloat(coords[0]);
            var lon = parseFloat(coords[1]);

            map.panTo([lat, lon], {
                animate: true,
                duration: .5
            });

        });
    });
</script>
</body>
</html>
